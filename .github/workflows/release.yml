name: Release

on:
  push:
    tags: [ 'v*' ]

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Cache NuGet packages
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.sln') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore NuGet packages
      run: dotnet restore SolidWorksReleasePack.sln

    - name: Build Release
      run: dotnet build SolidWorksReleasePack.sln --configuration Release --no-restore -p:SkipRegasm=true

    - name: Package artifacts
      run: |
        $tag = "${{ github.ref_name }}"
        $outDir = "release-pack-$tag"
        New-Item -ItemType Directory -Path $outDir -Force
        Copy-Item "src/ReleasePack.AddIn/bin/x64/Release/net48/*" -Destination $outDir -Recurse -Force
        Copy-Item "src/ReleasePack.Installer/bin/Release/ReleasePack.Installer.exe" -Destination $outDir -Force
        Copy-Item "scripts/*" -Destination "$outDir/scripts" -Recurse -Force
        Copy-Item "README.md" -Destination $outDir -Force
        Compress-Archive -Path $outDir -DestinationPath "SolidWorksReleasePack-$tag.zip"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          SolidWorksReleasePack-*.zip
          src/ReleasePack.Installer/bin/Release/ReleasePack.Installer.exe
        generate_release_notes: true
